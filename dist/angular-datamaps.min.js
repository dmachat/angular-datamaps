"use strict";angular.module("datamaps",[]),angular.module("datamaps").directive("datamap",["$compile",function(a){return{restrict:"EA",scope:{data:"=",options:"=",colors:"=?",type:"@?",onClick:"&?",fills:"=?"},link:function(b,c,d){function e(){return{element:c[0].children[0],scope:"usa"===b.type||"world"===b.type?b.type:"usa",height:b.height,width:b.width,projection:"world"===b.type?"mercator":"equirectangular",fills:{defaultFill:"#b9b9b9"},data:{},done:function(a){angular.isDefined(d.onClick)&&a.svg.selectAll(".datamaps-subunit").on("click",function(a){b.onClick()(a)})}}}function f(a,c){if(angular.forEach(c,function(b){a.data[b.location]={fillKey:b.value}}),angular.isDefined(b.fills))a.fills=b.fills;else if(!b.options.fillQuartiles){var d=[];angular.forEach(c,function(a){-1===d.indexOf(a.value)&&d.push(a.value)}),angular.isUndefined(b.colors)&&(b.colors=g()),angular.forEach(d,function(c,d){a.fills[c]=b.colors[d]})}return a}function g(){for(var a=d3.scale.category20(),b=[],c=0;20>c;c++)b.push(a(c));return b}b.mapOptions=e(),b.api={refresh:function(){b.api.updateWithOptions(b.options,b.data)},updateWithOptions:function(a,c){b.api.clearElement(),angular.isDefined(a)&&b.data.length&&(b.width=a.width||600,b.height=a.height||.6*b.width,b.legendHeight=a.legendHeight||50,b.mapOptions=e(),c[0].values.length&&(b.mapOptions=f(b.mapOptions,c[0].values)),b.mapOptions.geographyConfig=angular.extend({},a.geographyConfig),b.map=new Datamap(b.mapOptions),a&&(a.labels&&b.map.labels({labelColor:a.labelColor?a.labelColor:"#333333",fontSize:a.labelSize?a.labelSize:12}),a.legend&&b.map.legend()))},updateWithData:function(a){b.map.updateChoropleth(a)},clearElement:function(){b.map=null,c.empty();var d=a('<div style="position: relative; display: block; padding-bottom: {{ legendHeight }}px;"></div>')(b);c.append(d)}},b.$watch("[options, colors]",function(){b.api.refresh()},!0),b.$watch("data",function(a,c){if(a.length)if(c.length&&a[0].values.length===c[0].values.length){var d={};angular.forEach(a[0].values,function(a){d[a.location]={fillKey:a.value},angular.forEach(a,function(b,c){"value"!==c&&"location"!==c&&(d[a.location][c]=b)})}),b.api.updateWithData(d)}else b.api.refresh()},!0)}}}]);